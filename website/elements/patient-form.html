<dom-module id="patient-form">

	<link rel="import" href="../bower_components/iron-form/iron-form.html"/>
	<link rel="import" href="../bower_components/paper-input/paper-input.html"/>
	<link rel="import" href="../bower_components/paper-button/paper-button.html"/>
	<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"/>
	<link rel="import" href="gender-selector.html"/>
	<link rel="import" href="slide-panel.html"/>

	<style>

		form {
			width: 90%;
			margin: auto;
		}

		paper-button {
			float: right;
			margin-top: 40px;
		}

		@media screen and (min-width: 600px) {
			form {
				width: 50%;
			}

			paper-button {
				margin-top: 20px;
			}
		}
	</style>

	<template>
		<iron-ajax
				method="get"
				handle-as="json"
				on-response="patientResponse"
				id="getPatientRequest"></iron-ajax>

		<iron-ajax
				url="/patient"
				method="post"
				handle-as="json"
				id="postPatientRequest"></iron-ajax>

		<form is="iron-form" method="post" action="/patient" id="patientForm">
			<paper-input id="patientId" label="Patient id" required on-keyup="inputChanged" maxlength="8" char-counter></paper-input>
			<slide-panel id="moreInformation">
				<paper-input id="age" label="Age" required type="number"></paper-input>
				<gender-selector id="genderMenu" required></gender-selector>
			</slide-panel>

			<paper-button raised on-click="beginDiagnosis">Begin diagnosis</paper-button>
		</form>
	</template>

	<script>
		(function () {

			const PATIENT_URL = "/patient/";
			var lastRequest = "";

			Polymer({
				is: "patient-form",
				inputChanged: function (e) {
					if (e.target.value.length !== 8) return;
					if (lastRequest === e.target.value) return;
					lastRequest = e.target.value;
					this.$.getPatientRequest.url = PATIENT_URL + lastRequest;
					this.$.getPatientRequest.generateRequest();
				},
				patientResponse: function (e) {
					this.$.moreInformation.show();
					if (e.detail.status === 200)
						fillPatientData(this.$, e.detail.response);
				},
				beginDiagnosis: function () {
					if (!validate(this.$)) return;
					this.$.postPatientRequest.params = {
						patientId: this.$.patientId.value,
						age: this.$.age.value,
						gender: this.$.genderMenu.gender()
					};
					this.$.postPatientRequest.generateRequest();
					console.log("can send to server");
				}
			});

			function fillPatientData(element, patient) {
				element.age.value = patient.age;
				element.genderMenu.select(patient.gender);
			}

			function validate(element) {
				return element.patientForm.validate();
			}
		})();
	</script>

</dom-module>