<dom-module id="patient-form">

	<link rel="import" href="../bower_components/iron-form/iron-form.html"/>
	<link rel="import" href="../bower_components/paper-input/paper-input.html"/>
	<link rel="import" href="../bower_components/paper-button/paper-button.html"/>
	<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html"/>
	<link rel="import" href="../bower_components/paper-menu/paper-menu.html"/>
	<link rel="import" href="../bower_components/paper-item/paper-item.html"/>
	<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"/>
	<link rel="import" href="slide-panel.html"/>

	<style>

		form {
			width: 90%;
			margin: auto;
		}

		paper-item {
			width: calc(49% - 32px);
			display: inline-block;
			line-height: 50px;
			position: relative;
			cursor: pointer;
		}

		:host {
			--paper-menu-selected-item: {
				background-color: var(--paper-blue-900);
				color: white;
		    };

			--paper-menu-focused-item: {
				 background-color: var(--paper-blue-900);
				 color: white;
		    };
		}

		paper-button {
			float: right;
			margin-top: 40px;
		}

		paper-ripple {
			color: var(--paper-blue-100);
		}

		@media screen and (min-width: 600px) {
			form {
				width: 50%;
			}

			paper-button {
				margin-top: 20px;
			}
		}
	</style>

	<template>
		<iron-ajax
				method="get"
				handle-as="json"
				on-response="patientResponse"
				id="getPatientRequest"></iron-ajax>

		<iron-ajax
				url="/patient"
				method="post"
				handle-as="json"
				id="postPatientRequest"></iron-ajax>

		<form is="iron-form" method="post" action="/patient" id="patientForm">
			<paper-input id="patientId" label="Patient id" required on-keyup="inputChanged" maxlength="8" char-counter></paper-input>
			<slide-panel id="moreInformation">
				<paper-input id="age" label="Age" required type="number"></paper-input>
				<paper-menu id="sexMenu">
					<paper-item>
						<paper-ripple opacityDecayVelocity="2"></paper-ripple>Male
					</paper-item>
					<paper-item>
						<paper-ripple opacityDecayVelocity="2"></paper-ripple>Female
					</paper-item>
				</paper-menu>
			</slide-panel>

			<paper-button raised on-click="beginDiagnosis">Begin diagnosis</paper-button>
		</form>
	</template>

	<script>
		(function () {

			const PATIENT_URL = "/patient/";
			var lastRequest = "";

			Polymer({
				is: "patient-form",
				inputChanged: function (e) {
					if (e.target.value.length !== 8) return;
					if (lastRequest === e.target.value) return;
					lastRequest = e.target.value;
					this.$.getPatientRequest.url = PATIENT_URL + lastRequest;
					this.$.getPatientRequest.generateRequest();
				},
				patientResponse: function (e) {
					this.$.moreInformation.show();
					if (e.detail.status === 200)
						fillPatientData(this.$, e.detail.response);
				},
				beginDiagnosis: function () {
					if (!validate(this.$)) return;
					this.$.postPatientRequest.params = {
						patientId: this.$.patientId.value,
						age: this.$.age.value,
						sex: this.$.sexMenu.selected === 0 ? "Male" : "Female"
					};
					this.$.postPatientRequest.generateRequest();
					console.log("can send to server");
				}
			});

			function fillPatientData(element, patient) {
				element.age.value = patient.age;
				element.sexMenu.selected = isMale(patient.sex) ? 0 : 1;
			}

			function isMale(sex) {
				return sex.toLowerCase() === 'male';
			}

			function validate(element) {
				return element.patientForm.validate() && (element.sexMenu.selected === 0 || element.sexMenu.selected === 1);
			}
		})();
	</script>

</dom-module>