<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../character-selector/character-selector.html">
<link rel="import" href="../eye-selector/eye-selector.html">
<link rel="import" href="../degrees-selector/degrees-selector.html">

<dom-module id="test-configuration">
  <style>
    :host {
      display: block;
    }

    paper-menu {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }

    paper-item {
      cursor: pointer;
    }

    eye-selector {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }

    character-selector {
      padding-top: 90px;
    }

    degrees-selector {
      position: relative;
    }

    .eye-selector-container {
      position: fixed;
      padding-top: 10px;
      background-color: white;
      width: calc(100% - 270px);
      z-index: 10;
    }

    .degress-selector-container {
      position: fixed;
      width: 30px;
      height: 100%;
      z-index: 10;
      top: 64px;
      right: 10px;
    }

    degrees-selector {
      height: calc(100% - 72px);
    }

    @media (max-width: 600px) {

      .eye-selector-container {
        width: calc(100% - 15px);
      }
    }
  </style>
  <template>
    <iron-ajax
      url="/test"
      method="post"
      handle-as="json"></iron-ajax>
    <iron-pages selected="0">
      <div>
        <paper-menu selected={{selectedTest}}>
          <template is="dom-repeat" items="{{tests}}">
            <paper-item>{{item.name}}</paper-item>
          </template>
        </paper-menu>
      </div>
      <div>
        <div class="eye-selector-container">
          <eye-selector on-eye-selected="_eyeSelected"></eye-selector>
        </div>
        <div class="degress-selector-container">
          <degrees-selector on-degrees-selected="_degreesSelected"></degrees-selector>
        </div>
        <character-selector on-character-selected="_characterSelected"></character-selector>
      </div>
    </iron-pages>
  </template>
  <script>
  (() => {
    'use strict';

    Polymer({
      is: 'test-configuration',

      properties: {
        tests: Array,
        selectedTest: {
          type: String,
          observer: '_testSelected',
          value: '-1'
        },
        currentTestConfiguration: Object
      },

      observers: [

      ],

      configure: function (configuration) {
        this._reset();
        this.querySelector('degrees-selector').range = configuration.deviceRange;
        this.tests = configuration.tests;
      },

      back: function () {
        this._reset();
      },

      _reset: function () {
        this.querySelector('iron-pages').selected = '0';
        this.selectedTest = '-1';
        this.querySelector('character-selector').characters = [];
        this._clearConfiguration();
      },

      _testSelected: function () {
        if (this.selectedTest === '-1' || !this.tests) {
          return;
        }
        this.querySelector('iron-pages').selected = '1';
        this.querySelector('character-selector').characters = this.tests[this.selectedTest].characters;
        this.fire('test-started');
      },

      _eyeSelected: function (e) {
        this.currentTestConfiguration.eye = e.detail.eye;
        this._updateConfiguration();
      },

      _degreesSelected: function (e) {
        this._clearConfiguration();
        this.currentTestConfiguration.detail = e.detail.degrees;
      },

      _characterSelected: function (e) {
        this.currentTestConfiguration.character = e.detail.character;
        this._updateConfiguration();
      },

      _clearConfiguration: function () {
        this.currentTestConfiguration = {operation: 'showChar'};
      },

      _updateConfiguration: function () {
        if (!this._isConfigured('eye') || !this._isConfigured('detail') || !this._isConfigured('character')) {
          return;
        }
        this._notifyServer(this.querySelector('iron-ajax'));
        this._showRecord(this.currentTestConfiguration);
      },

      _isConfigured: function (parameter) {
        return this.currentTestConfiguration.hasOwnProperty(parameter);
      },

      _notifyServer: function (query) {
        query.body = JSON.stringify(this.currentTestConfiguration);
        query.generateRequest();
      },

      _showRecord: function (configuration) {
        this.fire('new-record', {
          char: configuration.character,
          testName: '',
          degrees: configuration.detail,
          eye: configuration.eye
        });
      }
    });
  })();
  </script>
</dom-module>
